<html>
  <head>
    <script type="module" src="/bin/schema.min.js"></script>
  </head>
  <body>
    <script type="module">
      import { runTests } from '@web/test-runner-mocha';
      import { expect } from "@esm-bundle/chai";
      const {
        TableType,
        AggType,
        DateUnit,
        TimeUnit,
        TimeZone,
        DataType,
        DecimalBitWidth,
        Document,
        DocumentData,
        DecimalOptsData,
        DateOptsData,
        TimeOptsData,
        TimestampOptsData,
      } = window['@hdml/schema'];
      
      runTests(async () => {
        describe("Document schema", () => {
          const documentData = {
            name: "Test HDML Document",
            tenant: "common",
            token: "sometokenhere",
            model: {
              name: "Test Model",
              host: "hostname",
              tables: [
                {
                  name: "table1",
                  type: TableType.Table,
                  source: "catalog.schema.table1",
                  fields: [
                    {
                      name: "field1",
                      origin: "origin1",
                      clause: "clause1",
                      description: "description1",
                      asc: false,
                    },
                    {
                      name: "field2",
                      origin: "origin2",
                      clause: "clause2",
                      description: "description2",
                      agg: AggType.Avg,
                    },
                  ],
                },
                {
                  name: "table2",
                  type: TableType.Table,
                  source: "catalog.schema.table2",
                  fields: [
                    {
                      name: "field1",
                      type: {
                        type: DataType.Int8,
                        options: {
                          nullable: true,
                        },
                      },
                    },
                    {
                      name: "field2",
                      type: {
                        type: DataType.Utf8,
                        options: {
                          nullable: true,
                        },
                      },
                    },
                    {
                      name: "field3",
                      type: {
                        type: DataType.Decimal,
                        options: {
                          nullable: true,
                          scale: 10,
                          precision: 10,
                          bitWidth: DecimalBitWidth._128,
                        },
                      },
                    },
                    {
                      name: "field4",
                      type: {
                        type: DataType.Date,
                        options: {
                          nullable: true,
                          unit: DateUnit.second,
                        },
                      },
                    },
                    {
                      name: "field5",
                      type: {
                        type: DataType.Time,
                        options: {
                          nullable: true,
                          unit: TimeUnit.nanosecond,
                        },
                      },
                    },
                    {
                      name: "field6",
                      type: {
                        type: DataType.Timestamp,
                        options: {
                          nullable: true,
                          unit: TimeUnit.nanosecond,
                          timezone: TimeZone.Europe_Kiev,
                        },
                      },
                    },
                  ],
                },
              ],
            },
          };
          let document1;
          let document2;

          it("must be constructible and parsable", () => {
            document1 = new Document(documentData);
            document2 = new Document(document1.buffer);

            expect(documentData.name).to.equal(document1.name);
            expect(documentData.name).to.equal(document2.name);

            expect(documentData.tenant).to.equal(document1.tenant);
            expect(documentData.tenant).to.equal(document2.tenant);

            expect(documentData.token).to.equal(document1.token);
            expect(documentData.token).to.equal(document2.token);

            expect(documentData.model.name).to.equal(document1.model?.name);
            expect(documentData.model.name).to.equal(document2.model?.name);

            expect(documentData.model.host).to.equal(document1.model?.host);
            expect(documentData.model.host).to.equal(document2.model?.host);

            expect(documentData.model.tables.length).to.equal(
              document1.model?.tables.length,
            );
            expect(documentData.model.tables.length).to.equal(
              document2.model?.tables.length,
            );

            documentData.model.tables.forEach((table, i) => {
              expect(table.name).to.equal(document1.model?.tables[i].name);
              expect(table.name).to.equal(document2.model?.tables[i].name);

              expect(table.type).to.equal(document1.model?.tables[i].type);
              expect(table.type).to.equal(document2.model?.tables[i].type);

              expect(table.source).to.equal(document1.model?.tables[i].source);
              expect(table.source).to.equal(document2.model?.tables[i].source);

              expect(table.fields.length).to.equal(
                document1.model?.tables[i].fields.length,
              );
              expect(table.fields.length).to.equal(
                document2.model?.tables[i].fields.length,
              );

              table.fields.forEach((field, j) => {
                expect(field.name).to.equal(
                  document1.model?.tables[i].fields[j].name,
                );
                expect(field.name).to.equal(
                  document2.model?.tables[i].fields[j].name,
                );

                if (i === 0) {
                  expect(field.origin).to.equal(
                    document1.model?.tables[i].fields[j].origin,
                  );
                  expect(field.origin).to.equal(
                    document2.model?.tables[i].fields[j].origin,
                  );

                  expect(field.clause).to.equal(
                    document1.model?.tables[i].fields[j].clause,
                  );
                  expect(field.clause).to.equal(
                    document2.model?.tables[i].fields[j].clause,
                  );

                  expect(field.description).to.equal(
                    document1.model?.tables[i].fields[j].description,
                  );
                  expect(field.description).to.equal(
                    document2.model?.tables[i].fields[j].description,
                  );

                  if (j === 0) {
                    expect(document1.model?.tables[i].fields[j].agg).to.equal(
                      AggType.None,
                    );
                    expect(document2.model?.tables[i].fields[j].agg).to.equal(
                      AggType.None,
                    );

                    expect(document1.model?.tables[i].fields[j].asc).to.equal(
                      false,
                    );
                    expect(document2.model?.tables[i].fields[j].asc).to.equal(
                      false,
                    );
                  }
                  if (j === 1) {
                    expect(document1.model?.tables[i].fields[j].agg).to.equal(
                      AggType.Avg,
                    );
                    expect(document2.model?.tables[i].fields[j].agg).to.equal(
                      AggType.Avg,
                    );

                    expect(document1.model?.tables[i].fields[j].asc).to.equal(
                      true,
                    );
                    expect(document2.model?.tables[i].fields[j].asc).to.equal(
                      true,
                    );
                  }
                }
                if (i === 1) {
                  const field1 = document1.model?.tables[i].fields[j];
                  const field2 = document2.model?.tables[i].fields[j];

                  if (field1 && field2) {
                    if (j === 0) {
                      expect(field1.type?.type).to.equal(DataType.Int8);
                      expect(field1.type?.options.nullable).to.be.true;

                      expect(field2.type?.type).to.equal(DataType.Int8);
                      expect(field2.type?.options.nullable).to.be.true;
                    }
                    if (j === 1) {
                      expect(field1.type?.type).to.equal(DataType.Utf8);
                      expect(field1.type?.options.nullable).to.be.true;

                      expect(field2.type?.type).to.equal(DataType.Utf8);
                      expect(field2.type?.options.nullable).to.be.true;
                    }
                    if (j === 2) {
                      const opts1 = field1.type?.options;
                      const opts2 = field2.type?.options;

                      expect(field1.type?.type).to.equal(DataType.Decimal);
                      expect(opts1.nullable).to.be.true;
                      expect(opts1.scale).to.equal(10);
                      expect(opts1.precision).to.equal(10);
                      expect(opts1.bitWidth).to.equal(DecimalBitWidth._128);

                      expect(field2.type?.type).to.equal(DataType.Decimal);
                      expect(opts2.nullable).to.be.true;
                      expect(opts2.scale).to.equal(10);
                      expect(opts2.precision).to.equal(10);
                      expect(opts2.bitWidth).to.equal(DecimalBitWidth._128);
                    }
                    if (j === 3) {
                      const opts1 = field1.type?.options;
                      const opts2 = field2.type?.options;

                      expect(field1.type?.type).to.equal(DataType.Date);
                      expect(opts1.nullable).to.be.true;
                      expect(opts1.unit).to.equal(DateUnit.second);

                      expect(field2.type?.type).to.equal(DataType.Date);
                      expect(opts2.nullable).to.be.true;
                      expect(opts2.unit).to.equal(DateUnit.second);
                    }
                    if (j === 4) {
                      const opts1 = field1.type?.options;
                      const opts2 = field2.type?.options;

                      expect(field1.type?.type).to.equal(DataType.Time);
                      expect(opts1.nullable).to.be.true;
                      expect(opts1.unit).to.equal(TimeUnit.nanosecond);

                      expect(field2.type?.type).to.equal(DataType.Time);
                      expect(opts2.nullable).to.be.true;
                      expect(opts2.unit).to.equal(TimeUnit.nanosecond);
                    }
                    if (j === 5) {
                      const opts1 = field1.type?.options;
                      const opts2 = field2.type?.options;

                      expect(field1.type?.type).to.equal(DataType.Timestamp);
                      expect(opts1.nullable).to.be.true;
                      expect(opts1.unit).to.equal(TimeUnit.nanosecond);
                      expect(opts1.timezone).to.equal(TimeZone.Europe_Kiev);

                      expect(field2.type?.type).to.equal(DataType.Timestamp);
                      expect(opts2.nullable).to.be.true;
                      expect(opts2.unit).to.equal(TimeUnit.nanosecond);
                      expect(opts2.timezone).to.equal(TimeZone.Europe_Kiev);
                    }
                  }
                }
              });
            });
          });
        });
      });
    </script>
  </body>
</html>
