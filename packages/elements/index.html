<!--
  @author Artem Lytvynov
  @copyright Artem Lytvynov
  @license Apache-2.0
-->

<!DOCTYPE html>
<html>
  <head>
    <script src="/bin/elements.min.js"></script>
    <script>
      const hdml = window['@hdml/elements'];
      (async () => {await hdml.defineDefaults();})();
    </script>
  </head>
    <body>
      <div>
        <hdml-io
          name="hdml.io"
          host="http://localhost:8888"
          tenant="common"
          token="eyJhbGciOiJSU0EtT0FFUC0yNTYiLCJlbmMiOiJBMjU2R0NNIn0.hCZXGfgGJ_zuHOZsxn6_NLk_HKqFQDDJrU6WfOiQzaAQ94XwAr4Wsu2yGJbTdunR4A-mmxtK7VSP7jxzZX0U13a_tX0-JNiYUc2H8aO-GGDfdQGEr0vB7iYiUl8O60zo_tUFX6Vt1g_53nLiegQ0z09gEuPxKHWG0p_FdhQl8YRys5Jt2m0qG52iax2tq1jpgTnfWp_SmvsKz9pj5DNjbjjxZJ0NsMtZ5BHIzfQkHZ3mwgLhP_Iy_1mucQlAmi43WfVFBbPPKxI4lJDX_4OJYyQUzG-L0xQcBD1qE1gZYhbW2eX_Wip1S8zBP2gArXB-vlZRf2kF4NPqah-TdAxJp-eB0Y6TZaHispuWbxgPMVQeJBhkU4dfQqQEuCFalCQn4vsT-DGKtBakH0zAVvz01S7OreBDwXNKkQsfQkQHTlQtV8V9cVAZY7Gp8LotjlBmZdPX-6b8qCS3xLqH_1-vsA9Qo-OBwxwwhaoCutlqX70tFLO34HJn_8xIGdm4hvXg.hOS52MpeIe8PgUFW.fTj01MfHsYt5n6Is5gHW8ckb8KPGnKYx0IAXUU16FsI_PIZhRikns_FcyRg9YRxnHjfboXjXE67B4KNQX_ODgLawrMxLdk1DYC6MTV9TiOzpZLvxS1-K1w8kjKM-LV0phtL6uEtx6TaD4WGF80D2I35HEklR.RxkSdmpugKXD7pVM29TEKw">
        </hdml-io>

        <hdml-model
          name="model">
          <hdml-table
            name="tables"
            type="table"
            source="`tenant_postgres`.`information_schema`.`tables`">
            <hdml-field
              name="catalog"
              origin="table_catalog">
            </hdml-field>
            <hdml-field
              name="schema"
              origin="table_schema">
            </hdml-field>
            <hdml-field
              name="table"
              origin="table_name">
            </hdml-field>
            <hdml-field
              name="full"
              clause="concat(`table_catalog`, '-', `table_schema`, '-', `table_name`)">
            </hdml-field>
            <hdml-field
              name="hash"
              clause="concat(`table_catalog`, '-', `table_schema`, '-', `table_name`)"
              type="binary">
            </hdml-field>
            <hdml-field
              name="type"
              origin="table_type">
            </hdml-field>
          </hdml-table>

          <hdml-table
            name="columns"
            type="query"
            source="select * from `tenant_postgres`.`information_schema`.`columns`">
            <hdml-field
              name="catalog"
              origin="table_catalog">
            </hdml-field>
            <hdml-field
              name="schema"
              origin="table_schema">
            </hdml-field>
            <hdml-field
              name="table"
              origin="table_name">
            </hdml-field>
            <hdml-field
              name="column"
              origin="column_name">
            </hdml-field>
            <hdml-field
              name="position"
              origin="ordinal_position"
              type="int-32">
            </hdml-field>
            <hdml-field
              name="default"
              origin="column_default">
            </hdml-field>
            <hdml-field
              name="nullable"
              origin="is_nullable">
            </hdml-field>
            <hdml-field
              name="type"
              origin="data_type">
            </hdml-field>
          </hdml-table>

          <hdml-join
            type="inner"
            left="tables"
            right="columns">
            <hdml-connective
              operator="and">
              <hdml-filter
                type="keys"
                left="catalog"
                right="catalog">
              </hdml-filter>
              <hdml-filter
                type="keys"
                left="schema"
                right="schema">
              </hdml-filter>
              <hdml-filter
                type="keys"
                left="table"
                right="table">
              </hdml-filter>            
              <hdml-connective
                operator="or">
                <hdml-filter
                  type="expr"
                  clause="`columns`.`table` = 'applicable_roles'">
                </hdml-filter>
                <hdml-filter
                  type="expr"
                  clause="`columns`.`table` = 'tables'">
                </hdml-filter>
                <hdml-connective
                  operator="or">
                  <hdml-filter
                    type="expr"
                    clause="1 = 1">
                </hdml-connective>
              </hdml-connective>
            </hdml-connective>
          </hdml-join>
        </hdml-model>

        <hdml-frame
          name="frame"
          source="/models/model.html?hdml-model=model"
          offset="0"
          limit="1000">
          <hdml-field
            name="catalog"
            origin="columns_catalog">
          </hdml-field>
          <hdml-field
            name="schema"
            origin="columns_schema">
          </hdml-field>
          <hdml-field
            name="table"
            origin="columns_table">
          </hdml-field>
          <hdml-field
            name="column"
            origin="columns_column">
          </hdml-field>
          <hdml-field
            name="count"
            origin="columns_column"
            agg="count">
          </hdml-field>

          <hdml-group-by>
            <hdml-field
              name="catalog">
            </hdml-field>
            <hdml-field
              name="schema">
            </hdml-field>
            <hdml-field
              name="table">
            </hdml-field>
            <hdml-field
              name="column">
            </hdml-field>
          </hdml-group-by>
        </hdml-frame>

        <hdml-frame
          name="query"
          source="/frames/frame.html?hdml-frame=frame">
          <div>
            <div>
              <hdml-field
                name="catalog">
              </hdml-field>
              <hdml-field
                name="schema">
              </hdml-field>
              <hdml-field
                name="table">
              </hdml-field>
              <hdml-field
                name="sum"
                origin="count"
                agg="sum">
              </hdml-field>
            </div>
          </div>

          <div>
            <hdml-filter-by>
              <hdml-connective
                operator="and">
                <hdml-filter
                  type="expr"
                  clause="`catalog` = 'tenant_postgres'">
                </hdml-filter>
                <hdml-filter
                  type="expr"
                  clause="`schema` = 'information_schema'">
                </hdml-filter>
              </hdml-connective>
            </hdml-filter-by>
          </div>

          <div>
            <hdml-group-by>
              <div>
                <hdml-field
                  name="catalog">
                </hdml-field>
                <hdml-field
                  name="schema">
                </hdml-field>
                <hdml-field
                  name="table">
                </hdml-field>
              </div>
            </hdml-group-by>
          </div>

          <div>
            <hdml-sort-by>
              <hdml-field
                name="catalog">
              </hdml-field>
              <hdml-field
                name="schema">
              </hdml-field>
              <hdml-field
                name="table"
                asc="true">
              </hdml-field>
            </hdml-sort-by>
          </div>
        </hdml-frame>
      </div>

      <script>
        const m = document.querySelector("hdml-model");
        const f1 = document.querySelector("hdml-frame[name=frame]");
        const f2 = document.querySelector("hdml-frame[name=query]");

        m.addEventListener("hdml-data", (event) => {
          console.log(event.detail.table.toString());
        });
        f1.addEventListener("hdml-data", (event) => {
          console.log(event.detail.table.toString());
        });
        f2.addEventListener("hdml-data", (event) => {
          console.log(event.detail.table.toString());
        });

        m.request();
        f1.request();
        f2.request();
      </script>
    </body>
</html>
